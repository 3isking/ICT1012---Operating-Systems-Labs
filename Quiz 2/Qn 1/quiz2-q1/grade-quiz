#!/usr/bin/env python3

import re
import sys
from gradelib import *

r = Runner(save("xv6.out"))

@test(1, "handshake")
def test_handshake():
    r.run_qemu(shell_script([
        'handshake 1012', 'echo OK'
    ]))
    r.match('^\\d+: parent received 1012 from child$', '^\\d+: child received 1012 from parent$', '^OK$')

# --- WRAPPER IMPLEMENTATION ---
# This prevents 'make' from throwing an 'Error 1' when a test fails.
# The student sees their score and the FAIL reason, but the script exits cleanly.
try:
    run_tests()
except SystemExit:
    # gradelib.run_tests() calls sys.exit(1) on failure or sys.exit(0) on success.
    # We intercept this and always exit 0 to keep the Makefile output clean.
    sys.exit(0)